<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta
      name="apple-mobile-web-app-title"
      content="Niharika's Bharatanatyam Rangapravesha"
    />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#000000" />
    <meta name="msapplication-TileColor" content="#000000" />
    <meta name="msapplication-navbutton-color" content="#000000" />
    
    <!-- Cache Control Meta Tags -->
    <meta http-equiv="Cache-Control" content="public, max-age=14400" />
    <meta http-equiv="Expires" content="14400" />
    <meta http-equiv="Pragma" content="public" />
    
    <title>Niharika's Bharatanatyam Rangapravesha</title>

    <!-- Add these Open Graph meta tags -->
    <meta
      property="og:title"
      content="Niharika's Bharatanatyam Rangapravesha"
    />
    <meta
      property="og:description"
      content="Niharika's Bharatanatyam Rangapravesha at Cary Arts Center"
    />
    <meta property="og:image" content="./images/page1.JPG" />
    <meta property="og:url" content="https://niha-arangetram.art/" />
    <meta property="og:type" content="website" />

    <!-- Add Twitter Card tags for Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta
      name="twitter:title"
      content="Niharika's Bharatanatyam Rangapravesha"
    />
    <meta
      name="twitter:description"
      content="Bharatanatyam Rangapravesha at Cary Arts Center"
    />
    <meta name="twitter:image" content="./images/page1.JPG" />

    <style>
      body {
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        min-height: 100dvh; /* Dynamic viewport height for mobile */
        font-family: Arial, sans-serif;
        background-color: #000000; /* Black background */
        /* Handle safe areas for devices with notches */
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
        /* Prevent scrolling but allow zooming */
        overscroll-behavior: none;
        -webkit-overflow-scrolling: touch;
      }

      #pageContainer {
        position: relative;
        max-width: 98vw;
        max-width: calc(
          98vw - env(safe-area-inset-left) - env(safe-area-inset-right)
        );
        height: 98vh;
        height: calc(
          98vh - env(safe-area-inset-top) - env(safe-area-inset-bottom)
        );
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      /* iOS-specific height reduction to avoid address bar overlap */
      @supports (-webkit-touch-callout: none) {
        #pageContainer {
          height: 95vh;
          height: calc(
            95vh - env(safe-area-inset-top) - env(safe-area-inset-bottom)
          );
        }
      }

      /* Alternative iOS detection using user agent targeting */
      @media screen and (-webkit-min-device-pixel-ratio: 0) {
        @supports (-webkit-appearance: none) {
          #pageContainer {
            height: 95vh;
            height: calc(
              95vh - env(safe-area-inset-top) - env(safe-area-inset-bottom)
            );
          }
        }
      }

      #imageContainer {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #currentImage {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        opacity: 1;
        transition: opacity 0.3s ease-in-out;
      }

      #currentImage.loading {
        opacity: 0.5;
      }

      .navButton {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0, 0, 0, 0.5);
        color: white;
        border: none;
        padding: 15px;
        cursor: pointer;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.3s;
        z-index: 10;
      }

      .navButton:disabled {
        background: rgba(0, 0, 0, 0.2);
        cursor: not-allowed;
      }

      .navButton:not(:disabled):hover {
        background: rgba(0, 0, 0, 0.8);
      }

      #prevButton {
        left: 10px;
      }

      #nextButton {
        right: 10px;
      }

      #pageIndicator {
        position: absolute;
        bottom: 20px;
        background: rgba(0, 0, 0, 0.5);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
      }

      #loadingIndicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        display: none;
      }

      .home-link {
        position: absolute;
        bottom: 20px;
        right: 80px;
        color: white;
        text-decoration: none;
        padding: 8px 12px;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 20px;
        font-size: 20px;
        transition: all 0.3s;
        z-index: 10;
        line-height: 1;
      }

      .home-link:hover {
        background: rgba(0, 0, 0, 0.8);
      }

      @media (max-width: 768px) {
        .navButton {
          width: 40px;
          height: 40px;
          padding: 10px;
        }

        #pageIndicator {
          font-size: 12px;
          padding: 6px 12px;
        }

        .home-link {
          font-size: 18px;
          padding: 6px 10px;
          bottom: 20px;
        }
      }

      /* Fullscreen and mobile-specific styles */
      @media screen and (display-mode: standalone) {
        /* Styles for when app is launched from home screen */
        body {
          padding-top: 0;
          padding-bottom: 0;
        }
      }

      /* Prevent text selection and context menus */
      * {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }

      /* Allow text selection for specific elements if needed */
      input,
      textarea {
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        user-select: text;
      }
    </style>
  </head>
  <body>
    <!-- Program Pages -->
    <div id="pageContainer">
      <div id="imageContainer">
        <img id="currentImage" src="./images/pg-1.jpg" alt="Page 1" />
        <button id="prevButton" class="navButton">←</button>
        <button id="nextButton" class="navButton">→</button>
        <div id="loadingIndicator">Loading...</div>
        <div id="pageIndicator">Page 1 of 1</div>
        <a
          href="#"
          onclick="goToFirstPage(event)"
          class="home-link"
          title="Back to Beginning"
          style="display: none"
          >↩</a
        >
      </div>
    </div>

    <script>
      // Static page configuration - exactly 17 pages
      const pages = [];
      const TOTAL_PAGES = 17;
      let isInitialized = false;

      // Function to initialize pages
      function initializePages() {
        try {
          // Create page objects for all 17 pages
          for (let pageNum = 1; pageNum <= TOTAL_PAGES; pageNum++) {
            pages.push({
              image: `pg-${pageNum}.jpg`,
              pageNum: pageNum,
            });
          }

          // Preload all images
          //preloadImages();

          // Initialize the app
          initializeApp();
        } catch (error) {
          console.error("Error in initializePages:", error);
          throw error; // Re-throw to be caught by the outer try-catch
        }
      }

      let currentIndex = 0;
      const loadedImages = new Set(); // Track which images have been loaded

      // Get DOM elements with error checking
      function getDOMElements() {
        const prevButton = document.getElementById("prevButton");
        const nextButton = document.getElementById("nextButton");
        const pageIndicator = document.getElementById("pageIndicator");
        const homeLink = document.querySelector(".home-link");

        if (!prevButton || !nextButton || !pageIndicator) {
          throw new Error("Required DOM elements not found");
        }

        return { prevButton, nextButton, pageIndicator, homeLink };
      }

      let prevButton, nextButton, pageIndicator, homeLink;

      function getImagePath() {
        // Check for GitHub Pages (including custom domains)
        const isGitHubPages =
          window.location.hostname.includes("github.io") ||
          window.location.hostname === "niha-arangetram.art" ||
          window.location.pathname.includes("/program-guide/");

        // For custom domain, we need to use absolute paths
        if (window.location.hostname === "niha-arangetram.art") {
          return "/images/";
        }

        // For regular GitHub Pages
        if (window.location.hostname.includes("github.io")) {
          return "/program-guide/images/";
        }

        // For local development
        return "./images/";
      }

      // Load a single image as needed
      function loadImage(pageIndex) {
        if (pageIndex >= 0 && pageIndex < pages.length) {
          const page = pages[pageIndex];
          const imagePath = `${getImagePath()}${page.image}`;
          
          const imgElement = document.getElementById("currentImage");
          
          // Only load if not already loaded
          if (!loadedImages.has(page.image)) {
            console.log(`Loading image: ${page.image} for page ${pageIndex}`);
            loadedImages.add(page.image);
            
            imgElement.src = imagePath;
            
            imgElement.onload = () => {
              console.log(`Successfully loaded: ${page.image}`);
              imgElement.classList.remove("loading");
              document.getElementById("loadingIndicator").style.display = "none";
            };
            
            imgElement.onerror = () => {
              console.error(`Failed to load image: ${page.image}`);
              imgElement.classList.remove("loading");
              document.getElementById("loadingIndicator").style.display = "none";
            };
          } else {
            console.log(`Image already loaded: ${page.image}`);
            // Set src for already loaded images to display them
            // Check if the src is already set to this image to avoid duplicate requests
            if (imgElement.src !== imagePath) {
              imgElement.src = imagePath;
            }
            imgElement.classList.remove("loading");
            document.getElementById("loadingIndicator").style.display = "none";
          }
        }
      }

      function updateNavigationButtons() {
        // First page: hide prev button, show next button
        if (currentIndex === 0) {
          prevButton.style.display = "none";
          nextButton.style.display = "block";
          homeLink.style.display = "none";
        }
        // Last page: show prev button, hide next button
        else if (currentIndex === pages.length - 1) {
          prevButton.style.display = "block";
          nextButton.style.display = "none";
          homeLink.style.display = "block";
        }
        // Middle pages: show both buttons
        else {
          prevButton.style.display = "block";
          nextButton.style.display = "block";
          homeLink.style.display = "block";
        }

        pageIndicator.textContent = `Page ${pages[currentIndex].pageNum} of ${pages.length}`;
      }

      function updateImage() {
        const imgElement = document.getElementById("currentImage");
        const loadingIndicator = document.getElementById("loadingIndicator");

        imgElement.classList.add("loading");
        loadingIndicator.style.display = "block";
        imgElement.alt = `Page ${pages[currentIndex].pageNum}`;

        // Load the image
        loadImage(currentIndex);

        updateNavigationButtons();

        // Update URL without page reload
        const newUrl = new URL(window.location);
        newUrl.searchParams.set("page", pages[currentIndex].pageNum);
        window.history.pushState({}, "", newUrl);
      }

      function navigateImage(direction) {
        currentIndex = Math.max(
          0,
          Math.min(pages.length - 1, currentIndex + direction)
        );
        updateImage();
      }

      function goToFirstPage(event) {
        event.preventDefault();
        currentIndex = 0;
        updateImage();
      }

      // Event Listeners - will be set up after DOM elements are available
      function setupEventListeners() {
        if (prevButton && nextButton) {
          prevButton.addEventListener("click", () => navigateImage(-1));
          nextButton.addEventListener("click", () => navigateImage(1));
        }
      }

      // Keyboard navigation
      document.addEventListener("keydown", (e) => {
        if (e.key === "ArrowLeft" && !prevButton.disabled) navigateImage(-1);
        if (e.key === "ArrowRight" && !nextButton.disabled) navigateImage(1);
      });

      // Touch support with better zoom handling
      let touchStartX = 0;
      let touchStartY = 0;
      let touchCount = 0;

      document.addEventListener("touchstart", (e) => {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
        touchCount = e.touches.length;
      });

      document.addEventListener("touchend", (e) => {
        // Only handle single-finger swipes (not pinch-to-zoom)
        if (touchCount === 1 && e.changedTouches.length === 1) {
          const touchEndX = e.changedTouches[0].clientX;
          const touchEndY = e.changedTouches[0].clientY;
          const diffX = touchStartX - touchEndX;
          const diffY = Math.abs(touchStartY - touchEndY);

          // Only navigate if it's a horizontal swipe (not vertical scroll/zoom)
          if (Math.abs(diffX) > 50 && diffY < 100) {
            if (diffX > 0 && !nextButton.disabled) navigateImage(1); // Swipe left
            if (diffX < 0 && !prevButton.disabled) navigateImage(-1); // Swipe right
          }
        }
      });

      function initializePage() {
        const urlParams = new URLSearchParams(window.location.search);
        const pageParam = urlParams.get("page");

        if (pageParam) {
          const pageIndex = pages.findIndex(
            (p) => p.pageNum === parseInt(pageParam)
          );
          if (pageIndex !== -1) {
            currentIndex = pageIndex;
          }
        } else {
          currentIndex = 0;
        }
        updateImage();
      }

      function initializeApp() {
        try {
          isInitialized = true;

          // Get DOM elements
          const elements = getDOMElements();
          prevButton = elements.prevButton;
          nextButton = elements.nextButton;
          pageIndicator = elements.pageIndicator;
          homeLink = elements.homeLink;

          // Initialize the page
          initializePage();

          // Setup event listeners
          setupEventListeners();
        } catch (error) {
          console.error("Error in initializeApp:", error);
          throw error;
        }
      }

      // iOS-specific height adjustment
      function adjustForIOS() {
        if (navigator.userAgent.match(/iPhone|iPad|iPod/i)) {
          const pageContainer = document.getElementById("pageContainer");
          if (pageContainer) {
            // Much more aggressive height reduction for iOS
            pageContainer.style.height = "85vh";
            pageContainer.style.height =
              "calc(85vh - env(safe-area-inset-top) - env(safe-area-inset-bottom))";

            // Also adjust the body to ensure proper centering
            document.body.style.minHeight = "100vh";
            document.body.style.minHeight = "100dvh";

            // Add much more bottom padding to avoid address bar
            pageContainer.style.paddingBottom = "100px";

            console.log(
              "iOS detected - height adjusted to 85vh with 100px bottom padding"
            );
          }
        }
      }

      // Start by initializing pages with error handling
      try {
        initializePages();
        // Apply iOS-specific adjustments
        adjustForIOS();
      } catch (error) {
        console.error("Error initializing application:", error);
        // Show a user-friendly error message
        const pageContainer = document.getElementById("pageContainer");
        if (pageContainer) {
          pageContainer.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #666;">
              <h3>Something went wrong</h3>
              <p>Please refresh the page or try again later.</p>
              <p>Error: ${error.message}</p>
            </div>
          `;
        }
      }

      // Handle browser back/forward buttons
      window.addEventListener("popstate", initializePage);
    </script>
  </body>
</html>
